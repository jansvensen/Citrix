# Enable required Features
enable feature SSLVPN

 # Add Gateway vServer (ICAOnly)
add vpn vserver gw_vs_gw.domain.local_ssl_443 SSL 1.1.1.1 443 -downStateFlush DISABLED -Listenpolicy NONE -ICAOnly ON

 # Add Session Policy Receiver
add vpn sessionAction sess_pro_sf_receiver -dnsVserverName lb_vs_basicservice_dns_53 -sessTimeout 2880 -transparentInterception OFF -defaultAuthorizationAction ALLOW -SSO ON -ssoCredential PRIMARY -windowsAutoLogon ON -icaProxy OFF -wihome "https://sf.domain.local/" -clientlessVpnMode ON -clientlessModeUrlEncoding TRANSPARENT -storefronturl "https://sf.domain.local/"
add vpn sessionPolicy sess_pol_sf_receiver "HTTP.REQ.HEADER(\"User-Agent\").CONTAINS(\"CitrixReceiver\") && HTTP.REQ.HEADER(\"X-Citrix-Gateway\").EXISTS" sess_pro_sf_receiver

 # Add Session Policy ReceiverWeb
add vpn sessionAction sess_pro_sf_receiverweb -dnsVserverName lb_vs_basicservice_dns_53 -sessTimeout 2880 -localLanAccess ON -rfc1918 OFF -defaultAuthorizationAction ALLOW -SSO ON -ssoCredential PRIMARY -windowsAutoLogon ON -icaProxy ON -wihome "https://sf.domain.local/Citrix/sodsWeb/" -wiPortalMode NORMAL -ClientChoices OFF -clientlessVpnMode OFF -clientlessModeUrlEncoding TRANSPARENT
add vpn sessionPolicy sess_pol_sf_receiverweb "HTTP.REQ.HEADER(\"User-Agent\").CONTAINS(\"CitrixReceiver\").NOT && HTTP.REQ.HEADER(\"Referer\").EXISTS" sess_pro_sf_receiverweb

 # Bind Session Policies
bind vpn vserver gw_vs_gw.domain.local_ssl_443 -policy sess_pol_sf_receiverweb -priority 100 -gotoPriorityExpression NEXT -type REQUEST
bind vpn vserver gw_vs_gw.domain.local_ssl_443 -policy sess_pol_sf_receiver -priority 110 -gotoPriorityExpression NEXT -type REQUEST


 # Bind STA Server
bind vpn vserver gw_vs_gw.domain.local_ssl_443 -staServer "http://ctxdc01.domain.local"
bind vpn vserver gw_vs_gw.domain.local_ssl_443 -staServer "http://ctxdc01.domain.local"

 # Bind Portal Theme
bind vpn vserver gw_vs_gw.domain.local_ssl_443 -portaltheme RfWebUI

 # Bind SSL Certificate
bind ssl vserver gw_vs_gw.domain.local_ssl_443 -certkeyName ssl_cert_wildcard.domain.local

 # Bind SSL Profile
set ssl vserver gw_vs_gw.domain.local_ssl_443 -sslProfile ssl_prof_fe_sslprofilename_TLS12_201812

 # TCP Profile for Virtual Apps and Desktops
set vpn vserver gw_vs_gw.domain.local_ssl_443 -tcpProfileName nstcp_default_XA_XD_profile

 # Strict HTTP Validation https://support.citrix.com/article/CTX227979 
set vpn vserver gw_vs_gw.domain.local_ssl_443 -httpProfileName http_prof_httpprofilename

# Configure Gateway Theme
bind vpn vserver gw_vs_gw.domain.local_ssl_443 -portaltheme gw_theme_x1_aaa_v001

# Create Basic Authentication Servers and Policies for 2FA

add authentication radiusAction auth_srv_basic_gw_radius-lb_rec -serverIP 9.9.9.9 -serverPort 1812 -authTimeout 15 -radKey 3c3a995ca60e1c2542772cf5240303ecf832badfa686fd58fffcd1c126a9ba765b3ff014063ae583afcaaecea53f2b5e -encrypted -encryptmethod ENCMTHD_3
add authentication radiusAction auth_srv_basic_gw_radius-lb_recweb -serverIP 9.9.9.9 -serverPort 1812 -authTimeout 15 -radKey 6fa0c143a56d095a2951d61fba8fdd1635e3913653342944d4582e168100aac1 -encrypted -encryptmethod ENCMTHD_3
add authentication radiusPolicy auth_pol_basic_gw_radius-lb_recweb ns_true auth_srv_basic_gw_radius-lb_recweb
add authentication radiusPolicy auth_pol_basic_gw_radius-lb_rec ns_true auth_srv_basic_gw_radius-lb_rec

add authentication ldapAction auth_srv_basic_gw_ldapTLS-lb_rec -serverIP 9.9.9.9 -ldapBase "dc=domain,dc=local" -ldapBindDn ldap-svc@domain.local -ldapBindDnPassword 662596a389468c6896cdd8209c03303b0a707de548acc7ac4153370301dd0e89 -encrypted -encryptmethod ENCMTHD_3 -ldapLoginName userPrincipalName -groupAttrName memberOf -subAttributeName cn -secType TLS -passwdChange ENABLED
add authentication ldapAction auth_srv_basic_gw_ldapTLS-lb_recweb -serverIP 9.9.9.9 -ldapBase "dc=domain,dc=local" -ldapBindDn ldap-svc@domain.local -ldapBindDnPassword 2d10232902a25d9d5ea950ea478fcf4c4d7829b35ef98e9895421187a5745d0e -encrypted -encryptmethod ENCMTHD_3 -ldapLoginName userPrincipalName -groupAttrName memberOf -subAttributeName cn -secType TLS -passwdChange ENABLED
add authentication ldapPolicy auth_pol_basic_gw_ldapTLS-lb_recweb ns_true auth_srv_basic_gw_ldapTLS-lb_recweb
add authentication ldapPolicy auth_pol_basic_gw_ldapTLS-lb_rec ns_true auth_srv_basic_gw_ldapTLS-lb_rec

# Bind basic authenticaion policies to GW vServer
bind vpn vserver gw_vs_gw.domain.local_ssl_443 -policy auth_pol_basic_gw_ldapTLS-lb_recweb -priority 100
bind vpn vserver gw_vs_gw.domain.local_ssl_443 -policy auth_pol_basic_gw_radius-lb_rec -priority 100
bind vpn vserver gw_vs_gw.domain.local_ssl_443 -policy auth_pol_basic_gw_radius-lb_recweb -priority 100 -secondary
bind vpn vserver gw_vs_gw.domain.local_ssl_443 -policy auth_pol_basic_gw_ldapTLS-lb_rec -priority 100 -secondary

# Save Configuration
save ns config