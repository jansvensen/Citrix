########################################################################################################
# Initialization Area
#
# Variables
#
# Backend Server IP 1 --> $backendserverip1$
# Backend Server IP 2 --> $backendserverip2$
# CS vServer IP --> $csvserverip$
#
#
#
########################################################################################################

# AAA Configuration - SSO
add tm sessionAction tm_act_coco_sso -SSO ON -ssoCredential PRIMARY -ssoDomain citrixguru.lab
add tm sessionPolicy tm_pol_coco_sso true tm_act_coco_sso

# AAA Configuration - AAA vServer
add authentication vserver aaa_vs_aaa-coco.domain.external_https_443 SSL 0.0.0.0
set ssl vserver aaa_vs_aaa-coco.domain.external_https_443 -sslProfile ssl_prof_fe_sslprofilename_TLS12_201812
bind authentication vserver aaa_vs_aaa-coco.domain.external_https_443 -policy auth_pol_ldap-tls_9.9.9.9_upn -priority 100 -gotoPriorityExpression NEXT
bind authentication vserver aaa_vs_aaa-coco.domain.external_https_443 -policy auth_pol_ldap-tls_9.9.9.9_sam -priority 101 -gotoPriorityExpression NEXT
bind authentication vserver aaa_vs_aaa-coco.domain.external_https_443 -policy tm_pol_coco_sso -priority 100 -gotoPriorityExpression NEXT

# AAA Configuration - Authentication Profile
add authentication authnProfile auth_prof_aaa-coco.domain.local -authnVsName aaa_vs_aaa-coco.domain.external_https_443 -AuthenticationHost aaa-coco.domain.local -AuthenticationDomain domain.local

# LB Monitor
add lb monitor lb_mon_coco_szc-heartbeat HTTP-ECV -send "GET /heartbeat.aspx" -recv "***ONLINE***" -LRTM DISABLED -secure YES

# Backend Servers
add server lb_srv_coco01.domain.local $backendserverip1$
add server lb_srv_coco02.domain.local $backendserverip1$

# ServiceGroup
add serviceGroup lb_sg_coco_ssl_443 SSL -maxClient 0 -maxReq 0 -cip DISABLED -usip NO -useproxyport YES -cltTimeout 180 -svrTimeout 360 -CKA NO -TCPB NO -CMP NO -tcpProfileName tcp_prof_profilename -httpProfileName http_prof_httpprofilename
bind serviceGroup lb_sg_coco_ssl_443 lb_srv_coco01.domain.local 443
bind serviceGroup lb_sg_coco_ssl_443 lb_srv_coco02.domain.local 443
bind serviceGroup lb_sg_coco_ssl_443 -monitorName lb_mon_coco_szc-heartbeat
set ssl serviceGroup lb_sg_coco_ssl_443 -sslProfile ssl_prof_be_sslprofilename_TLS12_201812

# LB vServer for CoCo Data
add lb vserver lb_vs_coco_data_ssl_443 SSL 0.0.0.0 0 -persistenceType SSLSESSION -lbMethod TOKEN -rule "http.REQ.URL.QUERY.VALUE(\"uploadid\")" -cltTimeout 180 -tcpProfileName tcp_prof_profilename -httpProfileName http_prof_httpprofilename
bind lb vserver lb_vs_coco_data_ssl_443 lb_sg_coco_ssl_443
set ssl vserver lb_vs_coco_data_ssl_443 -sslProfile ssl_prof_fe_sslprofilename_TLS12_201812
bind ssl vserver lb_vs_coco_data_ssl_443 -certkeyName ssl_cert_wildcard.domain.local

# LB vServer for CoCo Connectors
add lb vserver lb_vs_coco_conn_ssl_443 SSL 0.0.0.0 0 -persistenceType COOKIEINSERT -timeout 240 -cltTimeout 180 -authn401 ON -tcpProfileName tcp_prof_profilename -httpProfileName http_prof_httpprofilename -authnProfile auth_prof_aaa-coco.domain.local
bind lb vserver lb_vs_coco_conn_ssl_443 lb_sg_coco_ssl_443
set ssl vserver lb_vs_coco_conn_ssl_443 -sslProfile ssl_prof_fe_sslprofilename_TLS12_201812
bind ssl vserver lb_vs_coco_conn_ssl_443 -certkeyName ssl_cert_wildcard.domain.local

# LB vServer for CoCo Options
add lb vserver lb_vs_coco_cors_ssl_443 SSL 0.0.0.0 0 -persistenceType SSLSESSION -cltTimeout 180 -tcpProfileName tcp_prof_profilename -httpProfileName http_prof_httpprofilename
bind lb vserver lb_vs_coco_cors_ssl_443 lb_sg_coco_ssl_443
set ssl vserver lb_vs_coco_cors_ssl_443 -sslProfile ssl_prof_fe_sslprofilename_TLS12_201812
bind ssl vserver lb_vs_coco_cors_ssl_443 -certkeyName ssl_cert_wildcard.domain.local

# CS Actions
add cs action cs_act_coco_data -targetLBVserver lb_vs_coco_data_ssl_443
add cs action cs_act_coco_conn -targetLBVserver lb_vs_coco_conn_ssl_443
add cs action cs_act_coco_cors -targetLBVserver lb_vs_coco_cors_ssl_443

# CS Policies
add cs policy cs_pol_coco_data -rule "http.REQ.URL.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"coco.domain.local\") && HTTP.REQ.URL.CONTAINS(\"/cifs/\").NOT && HTTP.REQ.URL.CONTAINS(\"/sp/\").NOT && HTTP.REQ.URL.CONTAINS(\"/ProxyService/\").NOT" -action cs_act_coco_data
add cs policy cs_pol_coco_conn -rule "http.REQ.URL.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"coco.domain.local\") && (HTTP.REQ.URL.CONTAINS(\"/cifs/\") || HTTP.REQ.URL.CONTAINS(\"/sp/\") || HTTP.REQ.URL.CONTAINS(\"/ProxyService/\"))" -action cs_act_coco_conn
add cs policy cs_pol_coco_cors -rule "http.REQ.URL.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"coco.domain.local\") && HTTP.REQ.METHOD.EQ(OPTIONS)" -action cs_act_coco_cors

# CS vServer
add cs vserver cs_vs_coco.domain.local_ssl_443 SSL $csvserverip$ 443 -cltTimeout 180 -tcpProfileName tcp_prof_profilename -httpProfileName http_prof_httpprofilename
bind cs vserver cs_vs_coco.domain.local_ssl_443 -policyName cs_pol_coco_cors -priority 90
bind cs vserver cs_vs_coco.domain.local_ssl_443 -policyName cs_pol_coco_data -priority 100
bind cs vserver cs_vs_coco.domain.local_ssl_443 -policyName cs_pol_coco_conn -priority 110
set ssl vserver cs_vs_coco.domain.local_ssl_443 -sslProfile ssl_prof_fe_sslprofilename_TLS12_201812
bind ssl vserver cs_vs_coco.domain.local_ssl_443 -certkeyName ssl_cert_wildcard.domain.local

# http CallOut Ãœolicies for Data Validation
add policy httpCallout co_pol_coco_validation -vServer lb_vs_coco_data_ssl_443 -returnType BOOL -hostExpr "\"ShareFile\"" -urlStemExpr "\"/validate.ashxRequestURI=\" + HTTP.REQ.URL.BEFORE_STR(\"&h\").HTTP_URL_SAFE.B64ENCODE + \"&h=\"+ HTTP.REQ.URL.QUERY.VALUE(\"h\")" -scheme http -resultExpr "HTTP.RES.STATUS.EQ(200).NOT"
add policy httpCallout co_pol_coco_validation_y -vServer lb_vs_coco_data_ssl_443 -returnType BOOL -hostExpr "\"ShareFile\"" -urlStemExpr "\"/validate.ashxRequestURI=\" + HTTP.REQ.URL.HTTP_URL_SAFE.B64ENCODE + \"&h=\"" -scheme http -resultExpr "HTTP.RES.STATUS.EQ(200).NOT"

# Responder Policy for Data Validation
add responder policy resp_pol_coco_validation "HTTP.REQ.URL.CONTAINS(\"&h=\") && HTTP.REQ.URL.CONTAINS(\"crossdomain.xml\").NOT && HTTP.REQ.URL.CONTAINS(\"validate.ashx?requri\").NOT && SYS.HTTP_CALLOUT(co_pol_coco_validation) || HTTP.REQ.URL.CONTAINS(\"&h=\").NOT && HTTP.REQ.URL.CONTAINS(\"crossdomain.xml\").NOT && HTTP.REQ.URL.CONTAINS(\"validate.ashx?requri\").NOT && SYS.HTTP_CALLOUT(co_pol_coco_validation_y)" DROP
bind lb vserver lb_vs_coco_data_ssl_443 -policyName resp_pol_coco_validation -priority 100 -gotoPriorityExpression END -type REQUEST