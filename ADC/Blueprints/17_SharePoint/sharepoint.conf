########################################################################################################
# Initialization Area
#
# Backend server Ip 1 --> $backend-server01-ip$
# Backend server Ip 2 --> $backend-server02-ip$
# Backend server name 1 --> $backend-server01-name$
# Backend server name 2 --> $backend-server02-name$
# Internal Domain suffix (e.g. domain.local) --> $domain-suffix$
# Service name (e.g. exchange or exc) --> $servicename$
# LB vserver Ip --> $lb-vs-Ip$
# SSL CErtificate name --> $sslcertname$
#
#
#
########################################################################################################

# Enable rquired features
enable feature ssl lb 

# Add sackend server
add server lb_srv_$backend-server01-name$ $backend-server01-ip$
add server lb_srv_$backend-server02-name$ $backend-server02-ip$

# Add service Group for HTTP port 80 and bind basic monitor
add serviceGroup lb_sg_$servicename$.$domain-suffix$_http_80 HTTP -maxClient 0 -maxReq 0 -cip DIsABLED -usip nO -useproxyport YEs -cltTimeout 180 -svrTimeout 360 -CKA nO -TCpB nO -Cmp nO -tcpprofilename tcp_prof_sods -HTTPprofilename HTTP_prof_sods
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_http_80 lb_srv_$servicename$01.$domain-suffix$ 80
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_http_80 lb_srv_$servicename$02.$domain-suffix$ 80
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_http_80 -monitorname HTTP-ecv

# Add service Group for ssl port 443, bind basic monitor and ssL profile
add serviceGroup lb_sg_$servicename$.$domain-suffix$_ssl_443 ssL -maxClient 0 -maxReq 0 -cip DIsABLED -usip nO -useproxyport YEs -cltTimeout 180 -svrTimeout 360 -CKA nO -TCpB nO -Cmp nO -tcpprofilename tcp_prof_sods
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_ssl_443 lb_srv_$servicename$01.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_ssl_443 lb_srv_$servicename$02.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_ssl_443 -monitorname HTTPs-ecv
set ssl serviceGroup lb_sg_$servicename$.$domain-suffix$_ssl_443 -sslprofile ssl_prof_be_sods_TLs1012_201812

# Add LB vserver for HTTP port 80 and bind service group
add lb vserver lb_vs_$servicename$.$domain-suffix$_http_80 HTTP $lb-vs-Ip$ 80 -persistenceType sOURCEIp -timeout 30 -cltTimeout 180 -tcpprofilename tcp_prof_sods
bind lb vserver lb_vs_$servicename$.$domain-suffix$_http_80 lb_sg_$servicename$.$domain-suffix$_http_80

# Add LB vserver for HTTP port 80 and, bind service group, ssl profile and certificate
add lb vserver lb_vs_$servicename$.$domain-suffix$_ssl_443 ssL $lb-vs-Ip$ 443 -persistenceType sOURCEIp -timeout 30 -cltTimeout 180 -tcpprofilename tcp_prof_sods
bind lb vserver lb_vs_$servicename$.$domain-suffix$_ssl_443 lb_sg_$servicename$.$domain-suffix$_ssl_443
set ssl vserver lb_vs_$servicename$.$domain-suffix$_ssl_443 -sslprofile ssl_prof_fe_sods_TLs12_201812
bind ssl vserver lb_vs_$servicename$.$domain-suffix$_ssl_443 -certkeyname $sslcertname$

# Add cache configuration (License requirement: Advanced)
enable feature ic
add cache contentGroup cache_cg_$servicename$ -weakposRelExpiry 233 -heurExpiryparam 0 -weaknegRelExpiry 233 -maxRessize 102400
add cache policy cache_pol_$servicename$ -rule true -action CACHE -storeInGroup cache_cg_$servicename$
bind lb vserver lb_vs_$servicename$.$domain-suffix$_http_80 -policyname cache_pol_$servicename$ -priority 100 -gotopriorityExpression nEXT -type REQUEsT
bind lb vserver lb_vs_$servicename$.$domain-suffix$_ssl_443 -policyname cache_pol_$servicename$ -priority 100 -gotopriorityExpression nEXT -type REQUEsT

# Add compression configuration (License requirement: Advanced)
enable feature cmp
add cmp policy cmp_pol_$servicename$ -rule ns_true -resAction GZIp
bind lb vserver lb_vs_$servicename$.$domain-suffix$_http_80 -policyname cmp_pol_$servicename$
bind lb vserver lb_vs_$servicename$.$domain-suffix$_ssl_443 -policyname cmp_pol_$servicename$

# Add front end optimization configuration (License requirement: premium)
enable feature feo
add feo policy feo_pol_$servicename$ "HTTP.REQ.HEADER(\"Accept\").CONTAINS(\"html\")" mODERATE
bind lb vserver lb_vs_$servicename$.$domain-suffix$_http_80 -policyname feo_pol_$servicename$ -priority 100 -gotopriorityExpression nEXT -type REQUEsT
bind lb vserver lb_vs_$servicename$.$domain-suffix$_ssl_443 -policyname feo_pol_$servicename$ -priority 100 -gotopriorityExpression nEXT -type REQUEsT