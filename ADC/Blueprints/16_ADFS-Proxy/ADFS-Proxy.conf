########################################################################################################
# Initialization Area
#
# Backend Server IP 1 --> $backend-server01-ip$
# Backend Server IP 2 --> $backend-server02-ip$
# Backend Server Name 1 --> $backend-server01-name$
# Backend Server Name 2 --> $backend-server02-name$
# Internal Domain Suffix (e.g. $domain-suffix$) --> $domain-suffix$
# Service Name (e.g. exchange or exc) --> "servicename$"
# CS vServer IP --> $external-cs-IP$
# VC vServer URL --> $external-cs-URL$
# Customer Name --> $customername$
#
#
#
########################################################################################################

# Enable required Featuers
enable ns feature LB CS SSL REWRITE RESPONDER

# Add Rewrite Actions and Policies for AFD-Webproxy Replacement
add rewrite action rw_act_adfs_ProxyHeader insert_http_header X-MS-Proxy "\"NETSCALER\""
add rewrite action rw_act_adfs_ProxyMex replace HTTP.REQ.URL.PATH_AND_QUERY "\"/adfs/services/trust/proxymex\" + HTTP.REQ.URL.SET_TEXT_MODE(IGNORECASE).PATH_AND_QUERY.STRIP_START_CHARS(\"/adfs/services/trust/mex\").HTTP_URL_SAFE"
add rewrite policy rw_pol_adfs_ProxyHeader "http.REQ.URL.TO_LOWER.STARTSWITH(\"/adfs\")" rw_act_adfs_ProxyHeader
add rewrite policy rw_pol_adfs_ProxyMex "http.REQ.URL.TO_LOWER.STARTSWITH(\"/adfs/services/trust/mex\") " rw_act_adfs_ProxyMex

# Add LB Monitor
add lb monitor lb_mon_$internal-lb-URL$ HTTP-ECV -customHeaders "host: $internal-lb-URL$\r\n" -send "GET /federationmetadata/2007-06/federationmetadata.xml" -recv "$internal-lb-URL$/adfs/services/trust" -LRTM DISABLED -secure YES

# Add Backend Servers
add server lb_srv_$backend-server01-name$.$domain-suffix$ $backend-server01-ip$
add server lb_srv_$backend-server02-name$.$domain-suffix$ $backend-server02-ip$

# Add Service Group
add serviceGroup lb_sg_$internal-lb-URL$_ssl_443 SSL -maxClient 0 -maxReq 0 -cip DISABLED -usip NO -useproxyport YES -cltTimeout 180 -svrTimeout 360 -CKA NO -TCPB NO -CMP NO
bind serviceGroup lb_sg_$internal-lb-URL$_ssl_443 lb_srv_$backend-server01-name$.$domain-suffix$ 443
bind serviceGroup lb_sg_$internal-lb-URL$_ssl_443 lb_srv_$backend-server02-name$.$domain-suffix$ 443
bind serviceGroup lb_sg_$internal-lb-URL$_ssl_443 -monitorName lb_mon_$internal-lb-URL$
set ssl serviceGroup lb_sg_$internal-lb-URL$_ssl_443 -sslProfile ssl_prof_be_$customername$_TLS12_201812

# Add indirect LB vserver for O365
add lb vserver lb_vs_$internal-lb-URL$_o365_ssl_443 SSL 0.0.0.0 0 -persistenceType SSLSESSION -cltTimeout 180 -tcpProfileName tcp_prof_$customername$ -httpProfileName http_prof_$customername$
add cs action cs_act_adfs_o365 -targetLBVserver lb_vs_$internal-lb-URL$_o365_ssl_443
bind lb vserver lb_vs_$internal-lb-URL$_o365_ssl_443 lb_sg_$internal-lb-URL$_ssl_443
bind lb vserver lb_vs_$internal-lb-URL$_o365_ssl_443 -policyName rw_pol_adfs_ProxyHeader -priority 100 -gotoPriorityExpression NEXT -type REQUEST
bind lb vserver lb_vs_$internal-lb-URL$_o365_ssl_443 -policyName rw_pol_adfs_ProxyMex -priority 110 -gotoPriorityExpression NEXT -type REQUEST
set ssl vserver lb_vs_$internal-lb-URL$_o365_ssl_443 -sslProfile ssl_prof_fe_$customername$_TLS12_201812
bind ssl vserver lb_vs_$internal-lb-URL$_o365_ssl_443 -certkeyName ssl_cert_wildcard.$domain-suffix$

# Add indirect LB vserver for general ADFS purpose
add lb vserver lb_vs_$internal-lb-URL$_plain_ssl_443 SSL 0.0.0.0 0 -persistenceType SSLSESSION -cltTimeout 180 -tcpProfileName tcp_prof_$customername$ -httpProfileName http_prof_$customername$
add cs action cs_act_adfs_plain -targetLBVserver lb_vs_$internal-lb-URL$_plain_ssl_443
bind lb vserver lb_vs_$internal-lb-URL$_plain_ssl_443 lb_sg_$internal-lb-URL$_ssl_443
set ssl vserver lb_vs_$internal-lb-URL$_plain_ssl_443 -sslProfile ssl_prof_fe_$customername$_TLS12_201812
bind ssl vserver lb_vs_$internal-lb-URL$_plain_ssl_443 -certkeyName ssl_cert_wildcard.$domain-suffix$

# Add CS Actions and Policies
add cs action cs_act_adfs_plain -targetLBVserver lb_vs_$internal-lb-URL$_plain_ssl_443
add cs action cs_act_adfs_o365 -targetLBVserver lb_vs_$internal-lb-URL$_o365_ssl_443
add cs policy cs_pol_adfs_o365 -rule "HTTP.REQ.IS_VALID && http.REQ.HOSTNAME.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"$external-adfs-URL$\") && (http.REQ.URL.CONTAINS(\"/adfs/ls/wia\") || http.REQ.URL.CONTAINS(\"/adfs/services/trust\") || http.REQ.URL.CONTAINS(\"/federationmetadata/2007-06/federationmetadata.xml\") || http.REQ.URL.CONTAINS(\"/adfs/ls\") || http.REQ.URL.STARTSWITH(\"/adfs/portal\"))" -action cs_act_adfs_o365
add cs policy cs_pol_adfs_plain -rule "HTTP.REQ.IS_VALID && http.REQ.HOSTNAME.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"$external-adfs-URL$\")" -action cs_act_adfs_plain

# Add CS vServer
add cs vserver cs_vs_$external-cs-Name$_ssl_443 SSL $external-cs-IP$ 443 -cltTimeout 180 -tcpProfileName tcp_prof_$customername$ -httpProfileName http_prof_$customername$
bind cs vserver cs_vs_$external-cs-Name$_ssl_443 -policyName cs_pol_adfs_plain -priority 100
bind cs vserver cs_vs_$external-cs-Name$_ssl_443 -policyName cs_pol_adfs_o365 -priority 110
set ssl vserver cs_vs_$external-cs-Name$_ssl_443 -sslProfile ssl_prof_fe_$customername$_TLS12_201812
bind ssl vserver cs_vs_$external-cs-Name$_ssl_443 -certkeyName ssl_cert_wildcard.$domain-suffix$