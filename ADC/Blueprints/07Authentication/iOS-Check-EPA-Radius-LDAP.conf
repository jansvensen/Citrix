# Add Authentication Servers and Actions for Radius, LDAP and EPA
add authentication radiusAction auth_srv_$projectname$_radius_lb -serverIP 1.1.1.1 -serverPort 1812 -authTimeout 30 -radKey aaa -encrypted -encryptmethod ENCMTHD_3
add authentication ldapAction auth_srv_$projectname$_dom1_ldaps_lb -serverIP 1.1.1.1 -serverPort 636 -ldapBase "DC=domain,DC=one" -ldapBindDn "CN=serviceuser,DC=domain,DC=one" -ldapBindDnPassword aaa -encrypted -encryptmethod ENCMTHD_3 -ldapLoginName userPrincipalName -groupAttrName memberOf -subAttributeName cn -secType SSL -passwdChange ENABLED
add authentication ldapAction auth_srv_$projectname$_dom2_ldaps_lb -serverIP 1.1.1.2 -serverPort 636 -ldapBase "DC=domain,DC=two" -ldapBindDn "CN=serviceuser,DC=domain,DC=two" -ldapBindDnPassword aaa -encrypted -encryptmethod ENCMTHD_3 -ldapLoginName userPrincipalName -groupAttrName memberOf -subAttributeName cn -secType SSL -passwdChange ENABLED
add authentication epaAction auth_act_$projectname$_EPA_Win -csecexpr "(sys.client_expr(\"os_0_win7\") || sys.client_expr(\"os_0_win8\") || sys.client_expr(\"os_0_win8.1\") || sys.client_expr(\"os_0_win10\")) && sys.client_expr(\"sys_0_DOMAIN_SUFFIX_anyof_domain.one,domain.two[COMMENT: Domain check]\").NOT && sys.client_expr(\"sys_0_WIN-UPDATE_UPDATE-TYPE_==_AUTOMATIC[COMMENT: Windows Update]\") && (sys.client_expr(\"app_0_ANTIVIR_201_231_VERSION_<=_18.7_RTP_==_TRUE_VIRDEF-FILE-TIME_<=_4320[COMMENT: avast! Free Antivirus]\") || sys.client_expr(\"app_0_ANTIVIR_256_306_VERSION_<=_18.7_RTP_==_TRUE_SCAN-TIME_<_4320[COMMENT: AVG Internet Security]\") || sys.client_expr(\"app_0_ANTIVIR_294_1069_VERSION_<=_15.0_RTP_==_TRUE_VIRDEF-FILE-TIME_<=_4320[COMMENT: Avira Antivirus Pro]\") || sys.client_expr(\"app_0_ANTIVIR_295_359_VERSION_<=_19.0_RTP_==_TRUE_VIRDEF-FILE-TIME_<=_4320[COMMENT: Kaspersky Internet Security]\") || sys.client_expr(\"app_0_ANTIVIR_379_617_VERSION_<=_22.1_RTP_==_TRUE_VIRDEF-FILE-TIME_<=_4320[COMMENT: McAfee Internet Security]\") || sys.client_expr(\"app_0_ANTIVIR_90_362_VERSION_<=_4.18_RTP_==_TRUE_VIRDEF-FILE-TIME_<=_4320[COMMENT: Windows Defender]\") || sys.client_expr(\"app_0_ANTIVIR_240_1357_VERSION_<=_22.16_RTP_==_TRUE_VIRDEF-FILE-TIME_<=_4320[COMMENT: Norton Security]\") || sys.client_expr(\"app_0_ANTIVIR_148_513_VERSION_<=_15.0_RTP_==_TRUE_VIRDEF-FILE-TIME_<=_4320[COMMENT: Trend Micro Titanium Internet Security]\"))"
add authentication epaAction auth_act_$projectname$_EPA_Mac -csecexpr "sys.client_expr(\"app_0_MAC-PATCH_100011_100076_ENABLED_==_TRUE_MISSED-PATCH_allof_5,4[COMMENT: Software Update]\") && (sys.client_expr(\"app_0_MAC-ANTIVIR_100013_100130_VERSION_<=_13.11_RTP_==_TRUE_VIRDEF-FILE-TIME_<=_4320[COMMENT: Avast Mac Security]\") || sys.client_expr(\"app_0_MAC-ANTIVIR_100007_100069_VERSION_<=_3.1_RTP_==_TRUE_VIRDEF-FILE-TIME_<=_4320[COMMENT: Avira Mac Security]\") || sys.client_expr(\"app_0_MAC-ANTIVIR_100057_100070_VERSION_<=_7.1_RTP_==_TRUE_VIRDEF-FILE-TIME_<=_4320[COMMENT: Bitdefender Antivirus for Mac]\") || sys.client_expr(\"app_0_MAC-ANTIVIR_100056_100068_VERSION_<=_19.0_RTP_==_TRUE_VIRDEF-FILE-TIME_<=_4320[COMMENT: Kaspersky Internet Security]\") || sys.client_expr(\"app_0_MAC-ANTIVIR_100037_100204_VERSION_<=_8.1_VIRDEF-FILE-TIME_<=_4320[COMMENT: Norton Security]\") || sys.client_expr(\"app_0_MAC-ANTIVIR_100016_100129_VERSION_<=_9.0_RTP_==_TRUE_VIRDEF-FILE-TIME_<=_4320[COMMENT: Trend Micro Internet Security]\"))"

# Add Advanced Authentication Policies for NoAuth, Radius, LDAP and EP
add authentication Policy auth_pol_$projectname$_noauth -rule true -action NO_AUTHN
add authentication Policy auth_pol_$projectname$_iOS_Workspace -rule "(http.REQ.HEADER(\"User-Agent\").SET_TEXT_MODE(IGNORECASE).CONTAINS(\"iPod\") || http.REQ.HEADER(\"User-Agent\").SET_TEXT_MODE(IGNORECASE).CONTAINS(\"iPhone\") || http.REQ.HEADER(\"User-Agent\").SET_TEXT_MODE(IGNORECASE).CONTAINS(\"iOS\")  || http.REQ.HEADER(\"User-Agent\").SET_TEXT_MODE(IGNORECASE).CONTAINS(\"Safari\")) && http.REQ.HEADER(\"User-Agent\").SET_TEXT_MODE(IGNORECASE).CONTAINS(\"CitrixReceiver\")" -action NO_AUTHN
add authentication Policy auth_pol_$projectname$_iOS_Browser -rule "(http.REQ.HEADER(\"User-Agent\").SET_TEXT_MODE(IGNORECASE).CONTAINS(\"iPod\") || http.REQ.HEADER(\"User-Agent\").SET_TEXT_MODE(IGNORECASE).CONTAINS(\"iPhone\") || http.REQ.HEADER(\"User-Agent\").SET_TEXT_MODE(IGNORECASE).CONTAINS(\"iOS\")  || http.REQ.HEADER(\"User-Agent\").SET_TEXT_MODE(IGNORECASE).CONTAINS(\"Safari\")) && http.REQ.HEADER(\"User-Agent\").SET_TEXT_MODE(IGNORECASE).CONTAINS(\"CitrixReceiver\").NOT" -action NO_AUTHN
add authentication Policy auth_pol_$projectname$_dom2_ldaps_lb -rule true -action auth_srv_$projectname$_dom2_ldaps_lb
add authentication Policy auth_pol_$projectname$_dom1_ldaps_lb -rule true -action auth_srv_$projectname$_dom1_ldaps_lb
add authentication Policy auth_pol_$projectname$_radius_lb -rule true -action auth_srv_$projectname$_radius_lb
add authentication Policy auth_pol_$projectname$_EPA -rule "http.REQ.HEADER(\"User-Agent\").SET_TEXT_MODE(IGNORECASE).CONTAINS(\"iPod\").NOT && http.REQ.HEADER(\"User-Agent\").SET_TEXT_MODE(IGNORECASE).CONTAINS(\"iPhone\").NOT" -action NO_AUTHN
add authentication Policy auth_pol_$projectname$_EPA_Win -rule true -action auth_act_$projectname$_EPA_Win
add authentication Policy auth_pol_$projectname$_EPA_Mac -rule true -action auth_act_$projectname$_EPA_Mac

# Add Login Schemas // Remeber to edit the xml files manually!
add authentication loginSchema auth_ls_$projectname$ -authenticationSchema "/nsconfig/loginschema/LoginSchema/da_flipped_edited.xml" # xml should be custam DA_Flipped with field names swapped (OTP/Password)
add authentication loginSchema auth_ls_$projectname$_iOS-Workspace -authenticationSchema "/nsconfig/loginschema/LoginSchema/DualAuth.xml"

# Add Policy Label - http-enabled - Step 4 - LDAP
add authentication policylabel auth_pl_$projectname$_4th_ldap -loginSchema LSCHEMA_INT
bind authentication policylabel auth_pl_$projectname$_4th_ldap -policyName auth_pol_$projectname$_dom1_ldaps_lb -priority 100 -gotoPriorityExpression NEXT
bind authentication policylabel auth_pl_$projectname$_4th_ldap -policyName auth_pol_$projectname$_dom2_ldaps_lb -priority 110 -gotoPriorityExpression NEXT

# Add Policy Label - Receiver/WorkspaceApp - Step 4 - LDAP
add authentication policylabel auth_pl_$projectname$_4th_radius_Workspace -loginSchema LSCHEMA_INT
bind authentication policylabel auth_pl_$projectname$_4th_radius_Workspace -policyName auth_pol_$projectname$_radius_lb -priority 100 -gotoPriorityExpression NEXT

# Add Policy Label - http-enabled - Step 3 - RADIUS
add authentication policylabel auth_pl_$projectname$_3rd_radius -loginSchema auth_ls_$projectname$
bind authentication policylabel auth_pl_$projectname$_3rd_radius -policyName auth_pol_$projectname$_radius_lb -priority 100 -gotoPriorityExpression NEXT -nextFactor auth_pl_$projectname$_4th_ldap

# Add Policy Label - Receiver/WorkspaceApp - Step 3 - RADIUS
add authentication policylabel auth_pl_$projectname$_3rd_ldap_Workspace -loginSchema auth_ls_$projectname$_iOS-Workspace
bind authentication policylabel auth_pl_$projectname$_3rd_ldap_Workspace -policyName auth_pol_$projectname$_dom2_ldaps_lb -priority 100 -gotoPriorityExpression NEXT -nextFactor auth_pl_$projectname$_4th_radius_Workspace
bind authentication policylabel auth_pl_$projectname$_3rd_ldap_Workspace -policyName auth_pol_$projectname$_dom1_ldaps_lb -priority 110 -gotoPriorityExpression NEXT -nextFactor auth_pl_$projectname$_4th_radius_Workspace

# Add Policy Label - all - Step 2 - EPA
add authentication policylabel auth_pl_$projectname$_2nd_EPA -loginSchema LSCHEMA_INT
bind authentication policylabel auth_pl_$projectname$_2nd_EPA -policyName auth_pol_$projectname$_EPA_Win -priority 100 -gotoPriorityExpression NEXT -nextFactor auth_pl_$projectname$_3rd_radius
bind authentication policylabel auth_pl_$projectname$_2nd_EPA -policyName auth_pol_$projectname$_EPA_Mac -priority 110 -gotoPriorityExpression NEXT -nextFactor auth_pl_$projectname$_3rd_radius

# Add Policy Label - all - Step 2 - OS-Check
add authentication policylabel auth_pl_$projectname$_1st_OS -loginSchema LSCHEMA_INT
bind authentication policylabel auth_pl_$projectname$_1st_OS -policyName auth_pol_$projectname$_iOS_Workspace -priority 102 -gotoPriorityExpression NEXT -nextFactor auth_pl_$projectname$_3rd_ldap_Workspace
bind authentication policylabel auth_pl_$projectname$_1st_OS -policyName auth_pol_$projectname$_iOS_Browser -priority 104 -gotoPriorityExpression NEXT -nextFactor auth_pl_$projectname$_3rd_radius
bind authentication policylabel auth_pl_$projectname$_1st_OS -policyName auth_pol_$projectname$_EPA -priority 110 -gotoPriorityExpression NEXT -nextFactor auth_pl_$projectname$_2nd_EPA

# Add and configure Authentication vServer
add authentication vserver aaa_vs_$projectname$_ssl_443 SSL 0.0.0.0
bind authentication vserver aaa_vs_$projectname$_ssl_443 -portaltheme RfWebUI
bind authentication vserver aaa_vs_$projectname$_ssl_443 -policy auth_pol_$projectname$_noauth -priority 100 -nextFactor auth_pl_$projectname$_1st_OS -gotoPriorityExpression NEXT
set ssl vserver aaa_vs_$projectname$_ssl_443 -sslProfile ssl_prof_fe_domain_TLS12_201812
bind ssl vserver aaa_vs_$projectname$_ssl_443 -certkeyName ssl_cert_$projectname$

# Add Authentication Profile
add authentication authnProfile auth_prof_$projectname$ -authnVsName aaa_vs_$projectname$_ssl_443