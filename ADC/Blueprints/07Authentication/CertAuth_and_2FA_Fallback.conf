#SSL Profile erstellen. 
#Besonderheit: Client Authentication enabled und auf optional damit Client Cert angefordert werden kann und DenySSLRenegotiation auf FRONTEND_CLIENT um serverseitige Renegotiation zu ermöglichen
add ssl profile ssl_prof_fe_$KundenName$_Secure_nFactor -eRSA DISABLED -sessReuse ENABLED -sessTimeout 120 -clientAuth ENABLED -clientCert Optional -tls1 DISABLED -tls11 DISABLED -tls13 ENABLED -denySSLReneg FRONTEND_CLIENT -maxage 157680000 -dheKeyExchangeWithPsk YES

bind ssl profile ssl_prof_fe_$KundenName$_Secure_nFactor -eccCurveName P_256
bind ssl profile ssl_prof_fe_$KundenName$_Secure_nFactor -eccCurveName P_384
bind ssl profile ssl_prof_fe_$KundenName$_Secure_nFactor -eccCurveName P_224
bind ssl profile ssl_prof_fe_$KundenName$_Secure_nFactor -eccCurveName P_521
bind ssl profile ssl_prof_fe_$KundenName$_Secure_nFactor -cipherName ssl_cg_fe_BM_Secure -cipherPriority 1

#Besonderheit: Auch hier muss die serverseitige SSL Renegotiation enabled sein
#Mit Stand 29.05.2019 konnte die Unterstützung von anderen Browsern wie IE und der nativen Worksapce App nur hergestellt werden, wenn TLS 1.3 im SSL Profil deaktiviert ist!
#erfolgreiche Tests: 
    #Windows 10: IE, Chrome, native Workspace App
    #MacBook: Chrome, native Workspace App
    #iPad: Safari, Chrome
add ssl profile ssl_prof_fe_$KundenName$_Legacy_Rngtton -eRSA DISABLED -sessReuse ENABLED -sessTimeout 120 -tls1 DISABLED -tls11 DISABLED -denySSLReneg FRONTEND_CLIENT -maxage 157680000 -dheKeyExchangeWithPsk YES

bind ssl profile ssl_prof_fe_$KundenName$_Legacy_Rngtton -eccCurveName P_256
bind ssl profile ssl_prof_fe_$KundenName$_Legacy_Rngtton -eccCurveName P_384
bind ssl profile ssl_prof_fe_$KundenName$_Legacy_Rngtton -eccCurveName P_224
bind ssl profile ssl_prof_fe_$KundenName$_Legacy_Rngtton -eccCurveName P_521
bind ssl profile ssl_prof_fe_$KundenName$_Legacy_Rngtton -cipherName ssl_cg_fe_BM_Secure -cipherPriority 1

#Certificate Authentication Action und Policy erstellen: (Es wird an dieser Stelle davon ausgegangen, dass eine LDAP und RADIUS Policy besteht!)
#Voraussetzung ist ein vernünftiges Benutzerzertifikat. Wenn der Benutzername in einem anderen Feld als SubjectAltName steht, muss das angepasst werden!
add authentication certAction auth_srv_cert_nFACTOR -twoFactor ON -userNameField SubjectAltName:PrincipalName
#Binding zur Policy
add authentication Policy ag_auth_pol_cert_web -rule true -action auth_srv_cert_nFACTOR -logAction sys_audit_mes_aaa_err_login

#Login Schema erstellen
add authentication loginSchema sec_aaa_ls_prof_1Factor -authenticationSchema "/nsconfig/loginschema/LoginSchema/OnlyPassword.xml" -userCredentialIndex 1 -passwordCredentialIndex 2 -SSOCredentials YES
add authentication loginSchema sec_aaa_ls_prof_2Factor -authenticationSchema "/nsconfig/loginschema/LoginSchema/DualAuth.xml" -userCredentialIndex 1 -passwordCredentialIndex 2 -SSOCredentials YES
add authentication loginSchema sec_aaa_ls_prof_RADIUS -authenticationSchema noschema

#Login Schema
add authentication loginSchemaPolicy sec_aaa_ls_pol_CERT_INVALID -rule true -action sec_aaa_ls_prof_2Factor -logAction sys_audit_mes_aaa_err_login


# Authentication vServer erstellen. wenn nur ein Gateway mit Authentication Profile verwendet wird, braucht der aaa vServer keine IP. Wenn dieser Authentifizierungen für CS oder LB ausführen soll,
# muss er IP- und DNS-technisch erreichbar sein, da dann Redirecting genutzt wird!!
add authentication vserver sec_aaa_vs_nFACTOR SSL 0.0.0.0
#SSL Profil binden
set ssl vserver sec_aaa_vs_nFACTOR -sslProfile ssl_prof_fe_$KundenName$_Secure_nFactor
#Kunden Custom Theme hier binden, nicht am Gateway
bind authentication vserver sec_aaa_vs_nFACTOR -portaltheme nsg_theme_nFactor
#Policies binden
bind authentication vserver sec_aaa_vs_nFACTOR -policy sec_aaa_ls_pol_CERT_INVALID -priority 100 -gotoPriorityExpression END
bind authentication vserver sec_aaa_vs_nFACTOR -policy ag_auth_pol_cert_web -priority 100 -nextFactor sec_aaa_pl_CERT_VALID -gotoPriorityExpression NEXT
bind authentication vserver sec_aaa_vs_nFACTOR -policy ag_auth_pol_ldap_web -priority 120 -nextFactor sec_aaa_pl_RADIUS -gotoPriorityExpression NEXT
bind authentication vserver sec_aaa_vs_nFACTOR -policy SETASLEARNNSLOG_ADV_POL -priority 100 -gotoPriorityExpression NEXT

#Zertifikate binden. Wichtig: Wenn nur Benutzerzertifikate von bestimmten CAs erlaubt sein sollen, muss das Root oder Intermediate Cert der austellenden Instanz im aaa vServer hinterlegt sein
bind ssl vserver sec_aaa_vs_nFACTOR -certkeyName stern.$KundenName$.de
bind ssl vserver sec_aaa_vs_nFACTOR -certkeyName ssl_cer_Root_$KundenName$ -CA -ocspCheck Optional


#Wenn ein Gateway zur Verbindung zum aaa vServer genutzt wird, muss ein authentication Profile erstellt werden
add authentication authnProfile auth_pro_ext_nFactor -authnVsName sec_aaa_vs_nFACTOR -AuthenticationHost GW.$KundenName$.de

#Gateway mit angebundenem authentictaion Profile erstellen
add vpn vserver nsg_vs_GW_$KundenName$.de_ssl_443 SSL 192.168.101.100 443 -icaOnly ON -Listenpolicy NONE -tcpProfileName tcp_prof_BM -maxLoginAttempts 255 -failedLoginTimeout 1 -authnProfile auth_pro_ext_nFactor
#Auch am GW wird ein gesondertes SSL-Profil gebunden
set ssl vserver nsg_vs_GW_$KundenName$.de_ssl_443 -sslProfile ssl_prof_fe_$KundenName$_Legacy_Rngtton
