########################################################################################################
# Initialization Area
#
# Backend Server IP 1 --> $backend-server01-ip$
# Backend Server IP 2 --> $backend-server02-ip$
# Backend Server Name 1 --> $backend-server01-name$
# Backend Server Name 2 --> $backend-server02-name$
# Internal Domain Suffix (e.g. domain.local) --> $domain-suffix$
# Service Name (e.g. exchange or exc) --> $servicename$
# CS vServer IP --> $external-cs-IP$
# VC vServer URL --> $external-cs-URL$
# Customer Name --> $customername$
#
#
#
########################################################################################################


# Enable Features
enable ns feature AAA CS RESPONDER LB SSL FEO IC

# Create serves
add server lb_srv_$backend-server01-name$.$domain-suffix$ $backend-server01-ip$
add server lb_srv_$backend-server02-name$.$domain-suffix$ $backend-server02-ip$

# Create monitors
add lb monitor lb_mon_$servicename$.$domain-suffix$_smtp SMTP
add lb monitor lb_mon_$servicename$.$domain-suffix$_owa HTTP-ECV -send "GET /owa/healthcheck.htm" recv 200 -LRTM DISABLED -secure YES
add lb monitor lb_mon_$servicename$.$domain-suffix$_activesync HTTP-ECV -send "GET /Microsoft-Server-ActiveSync/healthcheck.htm" recv 200 -LRTM DISABLED -secure YES
add lb monitor lb_mon_$servicename$.$domain-suffix$_rpc HTTP-ECV -send "GET /rpc/healthcheck.htm" recv 200 -LRTM DISABLED -secure YES
add lb monitor lb_mon_$servicename$.$domain-suffix$_ews HTTP-ECV -send "GET /ews/healthcheck.htm" recv 200 -LRTM DISABLED -secure YES
add lb monitor lb_mon_$servicename$.$domain-suffix$_autodiscover HTTP-ECV -send "GET /Autodiscover/healthcheck.htm" recv 200 -LRTM DISABLED -secure YES
add lb monitor lb_mon_$servicename$.$domain-suffix$_oab HTTP-ECV -send "GET /oab/healthcheck.htm" recv 200 -LRTM DISABLED -secure YES
add lb monitor lb_mon_$servicename$.$domain-suffix$_mapi HTTP-ECV -send "GET /mapi/healthcheck.htm" recv 200 -LRTM DISABLED -secure YES
add lb monitor lb_mon_$servicename$.$domain-suffix$_ecp HTTP-ECV -send "GET /ecp/healthcheck.htm" recv 200 -LRTM DISABLED -secure YES

# Create Service Groups
add serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_25 TCP
add serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_465 TCP
add serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_587 TCP
add serviceGroup lb_sg_$servicename$.$domain-suffix$_imap_143 TCP
add serviceGroup lb_sg_$servicename$.$domain-suffix$_imap_993 TCP
add serviceGroup lb_sg_$servicename$.$domain-suffix$_owa_ssl_443 SSL
add serviceGroup lb_sg_$servicename$.$domain-suffix$_activesync_ssl_443 SSL
add serviceGroup lb_sg_$servicename$.$domain-suffix$_rpc_ssl_443 SSL
add serviceGroup lb_sg_$servicename$.$domain-suffix$_ews_ssl_443 SSL
add serviceGroup lb_sg_$servicename$.$domain-suffix$_autodiscover_ssl_443 SSL
add serviceGroup lb_sg_$servicename$.$domain-suffix$_oab_ssl_443 SSL
add serviceGroup lb_sg_$servicename$.$domain-suffix$_mapi_ssl_443 SSL
add serviceGroup lb_sg_$servicename$.$domain-suffix$_ecp_ssl_443 SSL

# Bind Service Groups
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_25 lb_srv_$servicename$.$domain-suffix$01.$domain-suffix$ 25
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_25 lb_srv_$servicename$.$domain-suffix$02.$domain-suffix$ 25
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_25 -monitorName lb_mon_$servicename$.$domain-suffix$_smtp

bind serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_465 lb_srv_$servicename$.$domain-suffix$01.$domain-suffix$ 465
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_465 lb_srv_$servicename$.$domain-suffix$02.$domain-suffix$ 465
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_465 -monitorName lb_mon_$servicename$.$domain-suffix$_smtp

bind serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_587 lb_srv_$servicename$.$domain-suffix$01.$domain-suffix$ 587
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_587 lb_srv_$servicename$.$domain-suffix$02.$domain-suffix$ 587
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_587 -monitorName lb_mon_$servicename$.$domain-suffix$_smtp

bind serviceGroup lb_sg_$servicename$.$domain-suffix$_imap_143 lb_srv_$servicename$.$domain-suffix$01.$domain-suffix$ 143
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_imap_143 lb_srv_$servicename$.$domain-suffix$02.$domain-suffix$ 143
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_imap_143 -monitorName tcp

bind serviceGroup lb_sg_$servicename$.$domain-suffix$_imap_993 lb_srv_$servicename$.$domain-suffix$01.$domain-suffix$ 993
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_imap_993 lb_srv_$servicename$.$domain-suffix$02.$domain-suffix$ 993
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_imap_993 -monitorName tcp

bind serviceGroup lb_sg_$servicename$.$domain-suffix$_owa_ssl_443 lb_srv_$servicename$.$domain-suffix$01.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_owa_ssl_443 lb_srv_$servicename$.$domain-suffix$02.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_owa_ssl_443 -monitorName lb_mon_$servicename$.$domain-suffix$_owa

bind serviceGroup lb_sg_$servicename$.$domain-suffix$_activesync_ssl_443 lb_srv_$servicename$.$domain-suffix$01.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_activesync_ssl_443 lb_srv_$servicename$.$domain-suffix$02.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_activesync_ssl_443 -monitorName lb_mon_$servicename$.$domain-suffix$_activesync

bind serviceGroup lb_sg_$servicename$.$domain-suffix$_rpc_ssl_443 lb_srv_$servicename$.$domain-suffix$01.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_rpc_ssl_443 lb_srv_$servicename$.$domain-suffix$02.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_rpc_ssl_443 -monitorName lb_mon_$servicename$.$domain-suffix$_rpc

bind serviceGroup lb_sg_$servicename$.$domain-suffix$_ews_ssl_443 lb_srv_$servicename$.$domain-suffix$01.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_ews_ssl_443 lb_srv_$servicename$.$domain-suffix$02.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_ews_ssl_443 -monitorName lb_mon_$servicename$.$domain-suffix$_ews

bind serviceGroup lb_sg_$servicename$.$domain-suffix$_autodiscover_ssl_443 lb_srv_$servicename$.$domain-suffix$01.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_autodiscover_ssl_443 lb_srv_$servicename$.$domain-suffix$02.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_autodiscover_ssl_443 -monitorName lb_mon_$servicename$.$domain-suffix$_autodiscover

bind serviceGroup lb_sg_$servicename$.$domain-suffix$_oab_ssl_443 lb_srv_$servicename$.$domain-suffix$01.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_oab_ssl_443 lb_srv_$servicename$.$domain-suffix$02.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_oab_ssl_443 -monitorName lb_mon_$servicename$.$domain-suffix$_oab

bind serviceGroup lb_sg_$servicename$.$domain-suffix$_mapi_ssl_443 lb_srv_$servicename$.$domain-suffix$01.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_mapi_ssl_443 lb_srv_$servicename$.$domain-suffix$02.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_mapi_ssl_443 -monitorName lb_mon_$servicename$.$domain-suffix$_mapi

bind serviceGroup lb_sg_$servicename$.$domain-suffix$_ecp_ssl_443 lb_srv_$servicename$.$domain-suffix$01.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_ecp_ssl_443 lb_srv_$servicename$.$domain-suffix$02.$domain-suffix$ 443
bind serviceGroup lb_sg_$servicename$.$domain-suffix$_ecp_ssl_443 -monitorName lb_mon_$servicename$.$domain-suffix$_ecp

# Create Load Balancer
add lb vserver lb_vs_$servicename$.$domain-suffix$_smtp_25 TCP 192.168.2.248 25
add lb vserver lb_vs_$servicename$.$domain-suffix$_smtp_465 TCP 192.168.2.248 465
add lb vserver lb_vs_$servicename$.$domain-suffix$_smtp_587 TCP 192.168.2.248 587
add lb vserver lb_vs_$servicename$.$domain-suffix$_imap_143 TCP 192.168.2.248 143
add lb vserver lb_vs_$servicename$.$domain-suffix$_imap_993 TCP 192.168.2.248 993
add lb vserver lb_vs_$servicename$.$domain-suffix$_owa SSL 0.0.0.0 0 -persistenceType SOURCEIP -timeout 30
add lb vserver lb_vs_$servicename$.$domain-suffix$_activesync SSL 0.0.0.0 0 -persistenceType SOURCEIP -timeout 30
add lb vserver lb_vs_$servicename$.$domain-suffix$_rpc SSL 0.0.0.0 0 -persistenceType SOURCEIP -timeout 30
add lb vserver lb_vs_$servicename$.$domain-suffix$_ews SSL 0.0.0.0 0 -persistenceType SOURCEIP -timeout 30
add lb vserver lb_vs_$servicename$.$domain-suffix$_autodiscover SSL 0.0.0.0 0 -persistenceType SOURCEIP -timeout 30
add lb vserver lb_vs_$servicename$.$domain-suffix$_oab SSL 0.0.0.0 0 -persistenceType SOURCEIP -timeout 30
add lb vserver lb_vs_$servicename$.$domain-suffix$_mapi SSL 0.0.0.0 0 -persistenceType SOURCEIP -timeout 30
add lb vserver lb_vs_$servicename$.$domain-suffix$_ecp SSL 0.0.0.0 0 -persistenceType SOURCEIP -timeout 30

# Bind Service Groups to vServer
bind lb vserver lb_vs_$servicename$.$domain-suffix$_smtp_25 lb_sg_$servicename$.$domain-suffix$_smtp_25
bind lb vserver lb_vs_$servicename$.$domain-suffix$_smtp_465 lb_sg_$servicename$.$domain-suffix$_smtp_465
bind lb vserver lb_vs_$servicename$.$domain-suffix$_smtp_587 lb_sg_$servicename$.$domain-suffix$_smtp_587
bind lb vserver lb_vs_$servicename$.$domain-suffix$_imap_143 lb_sg_$servicename$.$domain-suffix$_imap_143
bind lb vserver lb_vs_$servicename$.$domain-suffix$_imap_993 lb_sg_$servicename$.$domain-suffix$_imap_993
bind lb vserver lb_vs_$servicename$.$domain-suffix$_owa lb_sg_$servicename$.$domain-suffix$_owa_ssl_443
bind lb vserver lb_vs_$servicename$.$domain-suffix$_activesync lb_sg_$servicename$.$domain-suffix$_activesync_ssl_443
bind lb vserver lb_vs_$servicename$.$domain-suffix$_rpc lb_sg_$servicename$.$domain-suffix$_rpc_ssl_443
bind lb vserver lb_vs_$servicename$.$domain-suffix$_ews lb_sg_$servicename$.$domain-suffix$_ews_ssl_443
bind lb vserver lb_vs_$servicename$.$domain-suffix$_autodiscover lb_sg_$servicename$.$domain-suffix$_autodiscover_ssl_443
bind lb vserver lb_vs_$servicename$.$domain-suffix$_oab lb_sg_$servicename$.$domain-suffix$_oab_ssl_443
bind lb vserver lb_vs_$servicename$.$domain-suffix$_mapi lb_sg_$servicename$.$domain-suffix$_mapi_ssl_443
bind lb vserver lb_vs_$servicename$.$domain-suffix$_ecp lb_sg_$servicename$.$domain-suffix$_ecp_ssl_443

# Bind SSL certificate
bind ssl vserver lb_vs_$servicename$.$domain-suffix$_owa -certkeyName ssl_cert_wildcard.$domain-suffix$
bind ssl vserver lb_vs_$servicename$.$domain-suffix$_activesync -certkeyName ssl_cert_wildcard.$domain-suffix$
bind ssl vserver lb_vs_$servicename$.$domain-suffix$_rpc -certkeyName ssl_cert_wildcard.$domain-suffix$
bind ssl vserver lb_vs_$servicename$.$domain-suffix$_ews -certkeyName ssl_cert_wildcard.$domain-suffix$
bind ssl vserver lb_vs_$servicename$.$domain-suffix$_autodiscover -certkeyName ssl_cert_wildcard.$domain-suffix$
bind ssl vserver lb_vs_$servicename$.$domain-suffix$_oab -certkeyName ssl_cert_wildcard.$domain-suffix$
bind ssl vserver lb_vs_$servicename$.$domain-suffix$_mapi -certkeyName ssl_cert_wildcard.$domain-suffix$
bind ssl vserver lb_vs_$servicename$.$domain-suffix$_ecp -certkeyName ssl_cert_wildcard.$domain-suffix$

# Create Content Switch
add cs vserver cs_vs_$external-cs-URL$_ssl_443 SSL $external-cs-IP$ 443

# Replace certificate name
bind ssl vserver cs_vs_$external-cs-URL$_ssl_443 -certkeyName ssl_cert_wildcard.$domain-suffix$

# Create Content Switch Policies and Acions
add cs action cs_act_$servicename$.$domain-suffix$_owa -targetLBVserver lb_vs_$servicename$.$domain-suffix$_owa
add cs action cs_act_$servicename$.$domain-suffix$_ews -targetLBVserver lb_vs_$servicename$.$domain-suffix$_ews
add cs action cs_act_$servicename$.$domain-suffix$_autodiscover -targetLBVserver lb_vs_$servicename$.$domain-suffix$_autodiscover
add cs action cs_act_$servicename$.$domain-suffix$_activesync -targetLBVserver lb_vs_$servicename$.$domain-suffix$_activesync
add cs action cs_act_$servicename$.$domain-suffix$_oab -targetLBVserver lb_vs_$servicename$.$domain-suffix$_oab
add cs action cs_act_$servicename$.$domain-suffix$_mapi -targetLBVserver lb_vs_$servicename$.$domain-suffix$_mapi
add cs action cs_act_$servicename$.$domain-suffix$_rpc -targetLBVserver lb_vs_$servicename$.$domain-suffix$_rpc
add cs action cs_act_$servicename$.$domain-suffix$_ecp -targetLBVserver lb_vs_$servicename$.$domain-suffix$_ecp

add cs policy cs_pol_$servicename$.$domain-suffix$_owa -rule "http.REQ.HOSTNAME.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"$servicename$.$domain-suffix$\") && HTTP.REQ.URL.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"/owa\")" -action cs_act_$servicename$.$domain-suffix$_owa
add cs policy cs_pol_$servicename$.$domain-suffix$_ews -rule "http.REQ.HOSTNAME.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"$servicename$.$domain-suffix$\") && HTTP.REQ.URL.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"/ews\")" -action cs_act_$servicename$.$domain-suffix$_ews
add cs policy cs_pol_$servicename$.$domain-suffix$_autodiscover -rule "http.REQ.HOSTNAME.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"autodiscover.$domain-suffix$\") && HTTP.REQ.URL.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"/autodiscover\")" -action cs_act_$servicename$.$domain-suffix$_autodiscover
add cs policy cs_pol_$servicename$.$domain-suffix$_activesync -rule "http.REQ.HOSTNAME.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"$servicename$.$domain-suffix$\") && HTTP.REQ.URL.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"Microsoft-Server-ActiveSync\")" -action cs_act_$servicename$.$domain-suffix$_activesync
add cs policy cs_pol_$servicename$.$domain-suffix$_oab -rule "http.REQ.HOSTNAME.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"$servicename$.$domain-suffix$\") && HTTP.REQ.URL.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"/oab\")" -action cs_act_$servicename$.$domain-suffix$_oab
add cs policy cs_pol_$servicename$.$domain-suffix$_mapi -rule "http.REQ.HOSTNAME.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"$servicename$.$domain-suffix$\") && HTTP.REQ.URL.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"/mapi\")" -action cs_act_$servicename$.$domain-suffix$_mapi
add cs policy cs_pol_$servicename$.$domain-suffix$_rpc -rule "http.REQ.HOSTNAME.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"$servicename$.$domain-suffix$\") && HTTP.REQ.URL.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"/rpc\")" -action cs_act_$servicename$.$domain-suffix$_rpc
add cs policy cs_pol_$servicename$.$domain-suffix$_ecp -rule "http.REQ.HOSTNAME.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"$servicename$.$domain-suffix$\") && HTTP.REQ.URL.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"/ecp\")" -action cs_act_$servicename$.$domain-suffix$_ecp
add cs policy cs_pol_$servicename$.$domain-suffix$_cgi -rule "http.REQ.HOSTNAME.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"$servicename$.$domain-suffix$\") && HTTP.REQ.URL.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"/cgi\")" -action cs_act_$servicename$.$domain-suffix$_owa
add cs policy cs_pol_$servicename$.$domain-suffix$_owa_redirect -rule "http.REQ.HOSTNAME.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"$servicename$.$domain-suffix$\") && HTTP.REQ.HOSTNAME.EQ(\"mail.domain.external\")" -action cs_act_$servicename$.$domain-suffix$_owa
add cs policy cs_pol_$servicename$.$domain-suffix$_aaa -rule "http.REQ.HOSTNAME.SET_TEXT_MODE(IGNORECASE).CONTAINS(\"$servicename$.$domain-suffix$\") && HTTP.REQ.HOSTNAME.EQ(\"aaa.domain.external\")" -action cs_act_$servicename$.$domain-suffix$_aaa

# Redirect to OWA if only https://mail.domain.external will be entered
add cs policy cs_pol_$servicename$.$domain-suffix$_owa_redirect -rule 'HTTP.REQ.HOSTNAME.EQ("mail.domain.external")' -action cs_act_$servicename$.$domain-suffix$_owa

# Bind Content Switch Policies
bind cs vserver cs_vs_$external-cs-URL$_ssl_443 -policyName cs_pol_$servicename$.$domain-suffix$_owa -priority 100
bind cs vserver cs_vs_$external-cs-URL$_ssl_443 -policyName cs_pol_$servicename$.$domain-suffix$_ews -priority 110
bind cs vserver cs_vs_$external-cs-URL$_ssl_443 -policyName cs_pol_$servicename$.$domain-suffix$_autodiscover -priority 120
bind cs vserver cs_vs_$external-cs-URL$_ssl_443 -policyName cs_pol_$servicename$.$domain-suffix$_activesync -priority 130
bind cs vserver cs_vs_$external-cs-URL$_ssl_443 -policyName cs_pol_$servicename$.$domain-suffix$_oab -priority 140
bind cs vserver cs_vs_$external-cs-URL$_ssl_443 -policyName cs_pol_$servicename$.$domain-suffix$_mapi -priority 150
bind cs vserver cs_vs_$external-cs-URL$_ssl_443 -policyName cs_pol_$servicename$.$domain-suffix$_rpc -priority 160
bind cs vserver cs_vs_$external-cs-URL$_ssl_443 -policyName cs_pol_$servicename$.$domain-suffix$_ecp -priority 170
bind cs vserver cs_vs_$external-cs-URL$_ssl_443 -policyName cs_pol_$servicename$.$domain-suffix$_cgi -priority 180
bind cs vserver cs_vs_$external-cs-URL$_ssl_443 -policyName cs_pol_$servicename$.$domain-suffix$_owa_redirect -priority 190

# OWA HTTP Redirect (Responder)
add responder action resp_act_owa redirect '"https://"+HTTP.REQ.HOSTNAME+"/owa/"'
add responder policy resp_pol_owa 'HTTP.REQ.HOSTNAME.CONTAINS("mail.domain.external")' resp_act_owa
bind cs vserver cs_vs_$external-cs-URL$_ssl_443 -policyName resp_pol_owa -priority 100

# AAA LDAP SAM + UPN Authenticatio
add authentication ldapaction auth_act_ldap-tls_9.9.9.9_upn -serverip 9.9.9.9 -secType SSL -serverPort 636 -ldapBase "DC=lab,DC=local" -ldapBindDn svcldap@$domain-suffix$ -ldapBindDnPassword LDAPPW -ldapLoginName userPrincipalName -groupAttrName "memberOf" -subAttributeName "cn" -ssoNameAttribute userPrincipalName -passwdChange ENABLED -followReferrals ON
add authentication ldapaction auth_act_ldap-tls_9.9.9.9_sam -serverip 9.9.9.9 -secType SSL -serverPort 636 -ldapBase "DC=lab,DC=local" -ldapBindDn svcldap@$domain-suffix$ -ldapBindDnPassword LDAPPW -ldapLoginName sAMAccountName -groupAttrName "memberOf" -subAttributeName "cn" -ssoNameAttribute userPrincipalName -passwdChange ENABLED -followReferrals ON
add authentication Policy auth_pol_ldap-tls_9.9.9.9_upn -rule true -action auth_act_ldap-tls_9.9.9.9_upn
add authentication Policy auth_pol_ldap-tls_9.9.9.9_sam -rule true -action auth_act_ldap-tls_9.9.9.9_sam

# AAA vServer
add authentication vserver aaa_vs_aaa.domain.external_https_443 SSL 0.0.0.0
bind ssl vserver aaa_vs_aaa.domain.external_https_443 -certkeyName ssl_cert_wildcard.$domain-suffix$
bind authentication vserver aaa_vs_aaa.domain.external_https_443 -portaltheme X1
set ssl vserver aaa_vs_aaa.domain.external_https_443 -sslProfile ssl_prof_fe_$customername$e_TLS12_201812

# AAA Profile
add authentication authnProfile auth_prof_aaa.$domain-suffix$ -authnVsName aaa_vs_aaa.domain.external_https_443 -AuthenticationHost aaa.$domain-suffix$

# Bind LDAP Policies
bind authentication vserver aaa_vs_aaa.domain.external_https_443 -policy auth_pol_ldap-tls_9.9.9.9_upn -priority 100 -gotoPriorityExpression NEXT
bind authentication vserver aaa_vs_aaa.domain.external_https_443 -policy auth_pol_ldap-tls_9.9.9.9_sam -priority 101 -gotoPriorityExpression NEXT

# Create AAA Session Policy
add tm sessionAction tm_act_$servicename$.$domain-suffix$_owa_sso -defaultAuthorization ALLOW -SSO ON -ssoDomain 'lab.local'
add tm sessionPolicy tm_pol_$servicename$.$domain-suffix$_owa_sso 'HTTP.REQ.URL.CONTAINS("/owa/auth/logon.aspx")' tm_act_$servicename$.$domain-suffix$_owa_sso

# Set AAA Authentication at LB vServer level
set lb vserver lb_vs_$servicename$.$domain-suffix$_owa -AuthenticationHost aaa.$domain-suffix$ -Authentication ON -httpProfileName http_prof_$customername$ -authnProfile auth_prof_aaa.$domain-suffix$
set lb vserver lb_vs_$servicename$.$domain-suffix$_activesync -AuthenticationHost aaa.$domain-suffix$ -Authentication ON -httpProfileName http_prof_$customername$ -authnProfile auth_prof_aaa.$domain-suffix$
set lb vserver lb_vs_$servicename$.$domain-suffix$_rpc -AuthenticationHost aaa.$domain-suffix$ -Authentication ON -httpProfileName http_prof_$customername$ -authnProfile auth_prof_aaa.$domain-suffix$
set lb vserver lb_vs_$servicename$.$domain-suffix$_ews -AuthenticationHost aaa.$domain-suffix$ -Authentication ON -httpProfileName http_prof_$customername$ -authnProfile auth_prof_aaa.$domain-suffix$
set lb vserver lb_vs_$servicename$.$domain-suffix$_autodiscover -AuthenticationHost aaa.$domain-suffix$ -Authentication ON -httpProfileName http_prof_$customername$ -authnProfile auth_prof_aaa.$domain-suffix$
set lb vserver lb_vs_$servicename$.$domain-suffix$_oab -AuthenticationHost aaa.$domain-suffix$ -Authentication ON -httpProfileName http_prof_$customername$ -authnProfile auth_prof_aaa.$domain-suffix$
set lb vserver lb_vs_$servicename$.$domain-suffix$_mapi -AuthenticationHost aaa.$domain-suffix$ -Authentication ON -httpProfileName http_prof_$customername$ -authnProfile auth_prof_aaa.$domain-suffix$
set lb vserver lb_vs_$servicename$.$domain-suffix$_ecp -AuthenticationHost aaa.$domain-suffix$ -Authentication ON -httpProfileName http_prof_$customername$ -authnProfile auth_prof_aaa.$domain-suffix$

# Create SSO Form and Policies
add tm formSSOAction sso_profile_exchange_2016_owa -actionURL "/owa/auth.owa" -userField "username" -passwdField "password" -responsesize "60000" -ssoSuccessRule 'HTTP.RES.SET_COOKIE.COOKIE("cadata").VALUE("cadata").LENGTH.GT(70)' -nvtype DYNAMIC -submitMethod POST
 
add tm trafficAction traffic_prof_exchange_2016_owa -SSO ON -appTimeout 1 -formSSOAction sso_profile_exchange_2016_owa
add tm trafficAction traffic_prof_exchange_2016_owa_logout -InitiateLogout ON
 
add tm trafficPolicy traffic_pol_exchange_2016_owa 'HTTP.REQ.URL.CONTAINS("/owa/auth/logon.aspx")' traffic_prof_exchange_2016_owa
add tm trafficPolicy traffic_pol_exchange_2016_owa_logout 'HTTP.REQ.URL.CONTAINS("/owa/logoff.owa")' traffic_prof_exchange_2016_owa_logout

# Bind SSO Policies to the OWA vServer
bind lb vserver lb_vs_$servicename$.$domain-suffix$_owa -policyName traffic_pol_exchange_2016_owa -priority 100 -gotoPriorityExpression END -type REQUEST
bind lb vserver lb_vs_$servicename$.$domain-suffix$_owa -policyName traffic_pol_exchange_2016_owa_logout -priority 110 -gotoPriorityExpression END -type REQUEST

# Set FBA and 401 authentication
set lb vserver lb_vs_$servicename$.$domain-suffix$_owa -Authentication ON -authnVsName aaa_vs_aaa.domain.external_https_443 -AuthenticationHost aaa.domain.external
set lb vserver lb_vs_$servicename$.$domain-suffix$_ecp -Authentication ON -authnVsName aaa_vs_aaa.domain.external_https_443 -AuthenticationHost aaa.domain.external
set lb vserver lb_vs_$servicename$.$domain-suffix$_activesync -authn401 ON -authnVsName aaa_vs_aaa.domain.external_https_443
set lb vserver lb_vs_$servicename$.$domain-suffix$_autodiscover -authn401 ON -authnVsName aaa_vs_aaa.domain.external_https_443
set lb vserver lb_vs_$servicename$.$domain-suffix$_rpc -authn401 ON -authnVsName aaa_vs_aaa.domain.external_https_443
set lb vserver lb_vs_$servicename$.$domain-suffix$_ews -authn401 ON -authnVsName aaa_vs_aaa.domain.external_https_443
set lb vserver lb_vs_$servicename$.$domain-suffix$_oab -authn401 ON -authnVsName aaa_vs_aaa.domain.external_https_443
set lb vserver lb_vs_$servicename$.$domain-suffix$_mapi -authn401 ON -authnVsName aaa_vs_aaa.domain.external_https_443

# Content Switch AAA
add cs action cs_act_$servicename$.$domain-suffix$_aaa -targetVserver aaa_vs_aaa.domain.external_https_443
add cs policy cs_pol_$servicename$.$domain-suffix$_aaa -rule 'HTTP.REQ.HOSTNAME.EQ("aaa.domain.external")' -action cs_act_$servicename$.$domain-suffix$_aaa
bind cs vserver cs_vs_$external-cs-URL$_ssl_443 -policyName cs_pol_$servicename$.$domain-suffix$_aaa -priority 50

# Group Filtering
add authorization policy pol_auth_owa "AAA.USER.IS_MEMBER_OF(\"External-OWA\").NOT" DENY
add authorization policy pol_auth_outlook "AAA.USER.IS_MEMBER_OF(\"External-Outlook\").NOT" DENY
add authorization policy pol_auth_activesync "AAA.USER.IS_MEMBER_OF(\"External-ActiveSync\").NOT" DENY

bind lb vserver lb_vs_$servicename$.$domain-suffix$_owa -policyName pol_auth_owa -priority 100 -gotoPriorityExpression END -type REQUEST
bind lb vserver lb_vs_$servicename$.$domain-suffix$_ecp -policyName pol_auth_owa -priority 100 -gotoPriorityExpression END -type REQUEST
bind lb vserver lb_vs_$servicename$.$domain-suffix$_rpc -policyName pol_auth_outlook -priority 100 -gotoPriorityExpression END -type REQUEST
bind lb vserver lb_vs_$servicename$.$domain-suffix$_mapi -policyName pol_auth_outlook -priority 100 -gotoPriorityExpression END -type REQUEST
bind lb vserver lb_vs_$servicename$.$domain-suffix$_ews -policyName pol_auth_outlook -priority 100 -gotoPriorityExpression END -type REQUEST
bind lb vserver lb_vs_$servicename$.$domain-suffix$_oab -policyName pol_auth_outlook -priority 100 -gotoPriorityExpression END -type REQUEST
bind lb vserver lb_vs_$servicename$.$domain-suffix$_activesync -policyName pol_auth_activesync -priority 100 -gotoPriorityExpression END -type REQUEST

# OWA Deny Responder --> html page needs to be created first!
add responder action res_act_$servicename$.$domain-suffix$_owa_deny respondwithhtmlpage html_owa -responseStatusCode 200
add responder policy res_pol_$servicename$.$domain-suffix$_owa_deny "AAA.USER.IS_MEMBER_OF(\"External-OWA\").NOT" res_act_$servicename$.$domain-suffix$_owa_deny

# Front End Optimization
add feo policy feo_pol_$servicename$.$domain-suffix$ 'HTTP.REQ.HOSTNAME.CONTAINS("mail.domain.external")' MODERATE
bind cs vserver cs_vs_$external-cs-URL$_ssl_443 -policyName feo_pol_$servicename$.$domain-suffix$ -priority 100

# Configure SSL Security by binding SSL Profiles
set ssl vserver lb_vs_$servicename$.$domain-suffix$_owa -sslProfile ssl_prof_fe_$customername$e_TLS12_201812
set ssl vserver lb_vs_$servicename$.$domain-suffix$_activesync -sslProfile ssl_prof_fe_$customername$e_TLS12_201812
set ssl vserver lb_vs_$servicename$.$domain-suffix$_rpc -sslProfile ssl_prof_fe_$customername$e_TLS12_201812
set ssl vserver lb_vs_$servicename$.$domain-suffix$_ews -sslProfile ssl_prof_fe_$customername$e_TLS12_201812
set ssl vserver lb_vs_$servicename$.$domain-suffix$_autodiscover -sslProfile ssl_prof_fe_$customername$e_TLS12_201812
set ssl vserver lb_vs_$servicename$.$domain-suffix$_oab -sslProfile ssl_prof_fe_$customername$e_TLS12_201812
set ssl vserver lb_vs_$servicename$.$domain-suffix$_mapi -sslProfile ssl_prof_fe_$customername$e_TLS12_201812
set ssl vserver lb_vs_$servicename$.$domain-suffix$_ecp -sslProfile ssl_prof_fe_$customername$e_TLS12_201812
set ssl vserver cs_vs_$external-cs-URL$_ssl_443 -sslProfile ssl_prof_fe_$customername$e_TLS12_201812
set ssl vserver aaa_vs_aaa.domain.external_https_443 -sslProfile ssl_prof_fe_$customername$e_TLS12_201812

# Bind secure http Profile
set lb vserver lb_vs_$servicename$.$domain-suffix$_owa -httpProfileName http_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_activesync -httpProfileName http_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_rpc -httpProfileName http_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_ews -httpProfileName http_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_autodiscover -httpProfileName http_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_oab -httpProfileName http_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_mapi -httpProfileName http_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_ecp -httpProfileName http_prof_$customername$
set cs vserver cs_vs_$external-cs-URL$_ssl_443 -httpProfileName http_prof_$customername$

# Configure TCP
set serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_25 -tcpProfileName tcp_prof_$customername$
set serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_465 -tcpProfileName tcp_prof_$customername$
set serviceGroup lb_sg_$servicename$.$domain-suffix$_smtp_587 -tcpProfileName tcp_prof_$customername$
set serviceGroup lb_sg_$servicename$.$domain-suffix$_imap_143 -tcpProfileName tcp_prof_$customername$
set serviceGroup lb_sg_$servicename$.$domain-suffix$_imap_993 -tcpProfileName tcp_prof_$customername$
set serviceGroup lb_sg_$servicename$.$domain-suffix$_owa_ssl_443 -tcpProfileName tcp_prof_$customername$
set serviceGroup lb_sg_$servicename$.$domain-suffix$_activesync_ssl_443 -tcpProfileName tcp_prof_$customername$
set serviceGroup lb_sg_$servicename$.$domain-suffix$_rpc_ssl_443 -tcpProfileName tcp_prof_$customername$
set serviceGroup lb_sg_$servicename$.$domain-suffix$_ews_ssl_443 -tcpProfileName tcp_prof_$customername$
set serviceGroup lb_sg_$servicename$.$domain-suffix$_autodiscover_ssl_443 -tcpProfileName tcp_prof_$customername$
set serviceGroup lb_sg_$servicename$.$domain-suffix$_oab_ssl_443 -tcpProfileName tcp_prof_$customername$
set serviceGroup lb_sg_$servicename$.$domain-suffix$_mapi_ssl_443 -tcpProfileName tcp_prof_$customername$
set serviceGroup lb_sg_$servicename$.$domain-suffix$_ecp_ssl_443 -tcpProfileName tcp_prof_$customername$

set lb vserver lb_vs_$servicename$.$domain-suffix$_smtp_25 -tcpProfileName tcp_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_smtp_465 -tcpProfileName tcp_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_smtp_587 -tcpProfileName tcp_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_imap_143 -tcpProfileName tcp_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_imap_993 -tcpProfileName tcp_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_owa -tcpProfileName tcp_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_activesync -tcpProfileName tcp_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_rpc -tcpProfileName tcp_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_ews -tcpProfileName tcp_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_autodiscover -tcpProfileName tcp_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_oab -tcpProfileName tcp_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_mapi -tcpProfileName tcp_prof_$customername$
set lb vserver lb_vs_$servicename$.$domain-suffix$_ecp -tcpProfileName tcp_prof_$customername$